<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SafeText - User Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Roboto:wght@300;400;500&display=swap" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: "Roboto", sans-serif;
            background-color: #0f172a;
            /* bg-slate-900 */
        }
        
        .font-orbitron {
            font-family: "Orbitron", sans-serif;
        }
        
        .glass-pane {
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border: 1px solid rgba(56, 189, 248, 0.2);
            border-radius: 1rem;
        }
        
        .sidebar-link {
            transition: all 0.2s ease-in-out;
            border-left: 3px solid transparent;
        }
        
        .sidebar-link.active,
        .sidebar-link:hover {
            background-color: rgba(56, 189, 248, 0.1);
            color: #38bdf8;
            /* text-sky-400 */
            border-left-color: #38bdf8;
        }
        
        .section {
            display: none;
        }
        
        .section.active {
            display: block;
            animation: fadeIn 0.5s ease-in-out;
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .api-key-card {
            transition: opacity 0.3s ease-in-out;
        }
    </style>
</head>

<body class="text-slate-300">
    <!-- Background Glows -->
    <div class="absolute top-0 left-0 w-full h-full overflow-hidden pointer-events-none z-0">
        <div class="absolute top-[-20%] left-[-10%] w-[400px] h-[400px] bg-blue-500/20 rounded-full filter blur-3xl opacity-40"></div>
        <div class="absolute bottom-[-20%] right-[-10%] w-[500px] h-[500px] bg-sky-400/20 rounded-full filter blur-3xl opacity-40"></div>
    </div>

    <div class="relative min-h-screen lg:flex">
        <!-- Sidebar -->
        <aside class="z-20 lg:block w-64 flex-shrink-0 bg-slate-900/50 lg:bg-transparent">
            <div class="py-6 px-4">
                <div class="flex items-center gap-3 px-2 mb-8">
                    <div class="w-8 h-8 bg-yellow-400 rounded-lg flex items-center justify-center">
                        üõ°Ô∏è
                    </div>
                    <span class="text-xl font-orbitron font-bold text-white">SafeText</span
            >
          </div>
          <nav class="flex flex-col space-y-2">
            <a
              href="#dashboard"
              class="sidebar-link active text-lg px-4 py-3 rounded-r-lg"
              data-section="dashboard"
              ><i class="fas fa-home fa-fw mr-3"></i>Dashboard</a
            >
            <a
              href="#api-keys"
              class="sidebar-link text-lg px-4 py-3 rounded-r-lg"
              data-section="api-keys"
              ><i class="fas fa-key fa-fw mr-3"></i>API Keys</a
            >
            <a
              href="http://127.0.0.1:8000/docs"
              class="sidebar-link text-lg px-4 py-3 rounded-r-lg"
              id="document-open"
              target="_blank"
              rel="noopener noreferrer"
              ><i class="fas fa-book fa-fw mr-3"></i>Docs</a
            >
          </nav>
        </div>
      </aside>

      <!-- Main Content -->
      <main class="flex-1 p-6 lg:p-10">
        <!-- Header -->
        <div class="flex justify-between items-center mb-8">
          <h1 id="page-title" class="text-3xl font-orbitron text-white">
            Dashboard
          </h1>
          <div class="flex items-center gap-4">
            <span class="text-slate-400">Welcome, {{ user }}</span>
                    <a href="{{ url_for('logout') }}" class="px-4 py-2 bg-sky-500/20 text-sky-300 rounded-lg border border-sky-500/30 hover:bg-sky-500/40 transition">Logout</a
            >
          </div>
        </div>

        <!-- Dashboard Section -->
        <section id="dashboard" class="section active">
          <div class="container mx-auto p-4">
            <!-- Cards row -->
            <div
              class="flex flex-col lg:flex-row lg:space-x-4 space-y-4 lg:space-y-0 mb-6"
            >
              <!-- Credits Remaining -->
              <div class="flex-1 glass-pane p-5">
                <p class="text-sm font-medium text-slate-400">
                  Credits Remaining
                </p>
                <p
                  id="credits-remaining"
                  class="text-3xl font-bold text-white mt-2"
                >
                  {{ credit }}
                </p>
              </div>

              <!-- Total Analyzed -->
              <div class="flex-1 glass-pane p-5">
                <p class="text-sm font-medium text-slate-400">Total Analyzed</p>
                <p
                  id="total-analyzed"
                  class="text-3xl font-bold text-white mt-2"
                >
                  {{ totalanalysis }}
                </p>
              </div>
            </div>

            <!-- Chart -->
            <div class="glass-pane p-6 h-96">
              <h3 class="text-lg font-semibold text-white mb-4">
                API Usage This Week
              </h3>
              <canvas id="usageChart" class="w-full h-64 lg:h-96"></canvas>
            </div>
          </div>
        </section>
        <!-- API Keys Section -->
        <section id="api-keys" class="section">
          <div class="glass-pane p-6">
            <h3 class="text-lg font-semibold text-white mb-4">
              Manage Your API Keys
            </h3>
            <button
              id="generate-key-btn"
              class="px-5 py-2 bg-sky-500/80 text-white rounded-lg hover:bg-sky-500 transition mb-6"
            >
              <i class="fas fa-plus mr-2"></i>
              <span id="generate-key-btn-text">Generate New Key</span>
            </button>

            <div id="api-keys-list" class="space-y-4">
              {% if keys %} {% for key in keys %}
              <div
                class="api-key-card bg-slate-800/50 p-4 rounded-lg border border-slate-700"
                data-key="{{ key }}"
              >
                <p class="text-sm text-slate-400">
                  Created on {{ key.created_at }}
                </p>
                <div class="flex justify-between items-center mt-2">
                  <p class="api-key-value font-mono text-sky-400">{{ key }}</p>
                  <div class="flex space-x-2 text-sm">
                    <button
                      class="copy-key-btn bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 text-gray-900 dark:text-white px-4 py-2 rounded-lg font-medium transition-all duration-200 flex items-center justify-center"
                    >
                      <i class="fas fa-copy mr-1"></i>Copy
                    </button>
                    <button
                      class="delete-key-btn bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg font-medium transition-all duration-200 flex items-center justify-center"
                    >
                      <i class="fas fa-trash"></i>
                    </button>
                  </div>
                </div>
              </div>
              {% endfor %} {% else %}
              <p id="no-keys-message" class="text-slate-400">
                You don't have any API keys yet. Generate one to get started!
              </p>
              {% endif %}
            </div>
          </div>
        </section>
      </main>
    </div>

    <script>
          document.addEventListener('DOMContentLoaded', function() {
              // Navigation and Section Switching
              const links = document.querySelectorAll('.sidebar-link');
              const sections = document.querySelectorAll('.section');
              const pageTitle = document.getElementById('page-title');

              // Handle initial page load
              const initialHash = window.location.hash || '#dashboard';
              updateActiveState(initialHash);

              links.forEach(link => {
                  link.addEventListener('click', function(e) {
                      if (this.id === 'document-open') return;
                      e.preventDefault();
                      const targetId = this.getAttribute('href');
                      window.location.hash = targetId;
                  });
              });

              window.addEventListener('hashchange', () => {
                  updateActiveState(window.location.hash);
              });

              function updateActiveState(targetId) {
                  let found = false;
                  links.forEach(link => {
                      if (link.getAttribute('href') === targetId) {
                          link.classList.add('active');
                          pageTitle.textContent = link.textContent;
                          found = true;
                      } else {
                          link.classList.remove('active');
                      }
                  });

                  sections.forEach(section => {
                      if ('#' + section.id === targetId) {
                          section.classList.add('active');
                      } else {
                          section.classList.remove('active');
                      }
                  });

                  // Default to dashboard if hash is invalid
                  if (!found) {
                      document.querySelector('.sidebar-link[href="#dashboard"]').classList.add('active');
                      document.getElementById('dashboard').classList.add('active');
                      pageTitle.textContent = "Dashboard";
                  }
              }
      // Chart Initialization
                const chartDataFromBackend = {{ chart_data | tojson }};
                const ctx = document.getElementById('usageChart').getContext('2d');

          // NEW: create a mutable chart instance variable
          window.usageChart = null;

          if (ctx) {
              const initialValues = (chartDataFromBackend && chartDataFromBackend.values) ? chartDataFromBackend.values : [0,0,0,0,0,0,0];
              window.usageChart = new Chart(ctx, {
                  type: 'bar',
                  data: {
                      labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
                      datasets: [{
                          label: 'API Calls',
                          data: initialValues,
                          borderWidth: 1,
                          borderRadius: 6,
                          barThickness: 40
                      }]
                  },
                  options: {
                      responsive: true,
                      maintainAspectRatio: false,
                      plugins: { legend: { display: false } },
                      scales: {
                          y: {
                              beginAtZero: true,
                              grid: { color: 'rgba(56, 189, 248, 0.1)' },
                              ticks: { color: '#94a3b8' }
                          },
                          x: {
                              grid: { display: false },
                              ticks: { color: '#94a3b8' }
                          }
                      }
                  }
              });
          }
          // NEW: Polling to refresh stats + chart every X seconds
          (function() {
              const creditsEl = document.getElementById('credits-remaining');
              const totalEl = document.getElementById('total-analyzed');

              async function fetchUsageStats() {
                  try {
                      const res = await fetch('/api/usage-stats', { cache: 'no-store' });
                      if (!res.ok) {
                          // If unauthorized (logged out), you might want to redirect or stop polling
                          if (res.status === 404) {
                              console.warn('Not authorized for usage-stats (maybe logged out).');
                          }
                          return;
                      }
                      const data = await res.json();

                      if (data.credits_remaining !== undefined && creditsEl) {
                          creditsEl.textContent = data.credits_remaining;
                      }
                      if (data.total_analyzed !== undefined && totalEl) {
                          totalEl.textContent = data.total_analyzed;
                      }

                      // update chart if we have chart data
                      if (data.chart_data && window.usageChart && Array.isArray(data.chart_data.values)) {
                          window.usageChart.data.datasets[0].data = data.chart_data.values;
                          window.usageChart.update();
                      }
                  } catch (err) {
                      console.error('fetchUsageStats error:', err);
                  }
              }

              // Poll every 5 seconds (adjust as needed)
              const POLL_MS = 5000;
              //setInterval(fetchUsageStats, POLL_MS);
              // call once immediately
              fetchUsageStats();
          })();




              // Documentation button
              const docButton = document.getElementById('document-open');
              if (docButton) {
                  docButton.addEventListener('click', function(e) {
                      e.preventDefault();
                      window.open(this.href, '_blank');
                  });
              }

              // API Keys Functionality
              const generateBtn = document.getElementById('generate-key-btn');
              const keyList = document.getElementById('api-keys-list');

              // Event delegation for copy and delete buttons
              if (keyList) {
                  keyList.addEventListener('click', function(event) {
                      const target = event.target;
                      const copyBtn = target.closest('.copy-key-btn');
                      const deleteBtn = target.closest('.delete-key-btn');

                      if (copyBtn) {
                          handleCopyKey(copyBtn);
                      }

                      if (deleteBtn) {
                          handleDeleteKey(deleteBtn);
                      }
                  });
              }

              // Generate new API key - updated version
              if (generateBtn) {
                  generateBtn.addEventListener('click', async function() {
                      const btnText = document.getElementById('generate-key-btn-text');
                      const originalText = btnText.textContent;
                      btnText.textContent = 'Generating...';
                      generateBtn.disabled = true;

                      try {
                          const response = await fetch('/api/generate-key', {
                              method: 'POST',
                              headers: {
                                  'Content-Type': 'application/json',
                                  // Add CSRF token if needed
                              }
                          });

                          const data = await response.json();

                          if (!response.ok) {
                              throw new Error(data.error || 'Failed to generate key');
                          }

                          if (data.success) {
                              // Properly handle the successful response
                              addKeyToDOM(data.api_key, data.created_at);

                              // Show success message
                              const successMsg = document.createElement('div');
                              successMsg.className = 'bg-green-500/20 text-green-300 p-3 rounded-lg mb-4';
                              successMsg.innerHTML = `
                                  <i class="fas fa-check-circle mr-2"></i>
                                  ${data.message || 'API key generated successfully!'}
                              `;
                              keyList.prepend(successMsg);

                              // Remove message after 5 seconds
                              setTimeout(() => successMsg.remove(), 5000);
                          } else {
                              throw new Error(data.message || 'Key generation failed');
                          }
                      } catch (error) {
                          console.error('Key generation error:', error);

                          // Show error message
                          const errorMsg = document.createElement('div');
                          errorMsg.className = 'bg-red-500/20 text-red-300 p-3 rounded-lg mb-4';
                          errorMsg.innerHTML = `
                              <i class="fas fa-exclamation-circle mr-2"></i>
                              ${error.message || 'Failed to generate API key'}
                          `;
                          keyList.prepend(errorMsg);

                          // Remove message after 5 seconds
                          setTimeout(() => errorMsg.remove(), 5000);
                      } finally {
                          btnText.textContent = originalText;
                          generateBtn.disabled = false;
                      }
                  });
              }


              // Function to add new key to DOM
              function addKeyToDOM(apiKey, createdAt) {
                  const noKeysMessage = document.getElementById('no-keys-message');
                  if (noKeysMessage) noKeysMessage.remove();

                  const keyCard = document.createElement('div');
                  keyCard.className = 'api-key-card bg-slate-800/50 p-4 rounded-lg border border-slate-700';
                  keyCard.dataset.key = apiKey;
                  keyCard.innerHTML = `
                      <p class="text-sm text-slate-400">Created on ${createdAt}</p>
                      <div class="flex justify-between items-center mt-2">
                          <p class="api-key-value font-mono text-sky-400">${apiKey}</p>
                          <div class="flex space-x-2">
                              <button class="copy-key-btn bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 text-gray-900 dark:text-white px-4 py-2 rounded-lg font-medium transition-all duration-200 flex items-center justify-center">
                                  <i class="fas fa-copy mr-1"></i>Copy
                              </button>
                              <button class="delete-key-btn bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg font-medium transition-all duration-200 flex items-center justify-center">
                                  <i class="fas fa-trash"></i>
                              </button>
                          </div>
                      </div>
                  `;

                  if (keyList) {
                      keyList.prepend(keyCard);
                  }
              }

              // Handle copy key functionality
              function handleCopyKey(button) {
                  const keyCard = button.closest('.api-key-card');
                  if (!keyCard) return;

                  const apiKey = keyCard.dataset.key;
                  if (!apiKey) return;

                  navigator.clipboard.writeText(apiKey).then(() => {
                      // Visual feedback
                      const originalText = button.innerHTML;
                      button.innerHTML = '<i class="fas fa-check mr-1"></i>Copied!';
                      button.classList.add('bg-green-500', 'hover:bg-green-600');

                      setTimeout(() => {
                          button.innerHTML = originalText;
                          button.classList.remove('bg-green-500', 'hover:bg-green-600');
                      }, 2000);
                  }).catch(err => {
                      console.error('Failed to copy: ', err);
                      alert('Failed to copy API key');
                  });
              }


              // Handle delete key functionality
              function handleDeleteKey(button) {
                  if (!confirm('Are you sure you want to delete this API key? This action cannot be undone.')) {
                      return;
                  }

                  const keyCard = button.closest('.api-key-card');
                  if (!keyCard) return;

                  const apiKey = keyCard.dataset.key;
                  if (!apiKey) return;

                  // Add delete animation
                  keyCard.classList.add('opacity-0', 'transition-opacity', 'duration-300');

                  // Show loading state on button
                  const originalContent = button.innerHTML;
                  button.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i>Deleting...';
                  button.disabled = true;

                  fetch('/api/delete-key', {
                      method: 'DELETE',
                      headers: {
                          'Content-Type': 'application/json',
                          // Add CSRF token if needed
                      },
                      body: JSON.stringify({ key: apiKey })
                  })
                  .then(response => {
                      if (!response.ok) {
                          throw new Error('Delete failed');
                      }
                      return response.json();
                  })
                  .then(data => {
                      if (data.success) {
                          // Remove element after successful deletion
                          setTimeout(() => {
                              keyCard.remove();

                              // Check if we should show the "no keys" message
                              if (keyList && keyList.querySelectorAll('.api-key-card').length === 0) {
                                  keyList.innerHTML = '<p id="no-keys-message" class="text-slate-400">You don\'t have any API keys yet. Generate one to get started!</p>';
                              }
                          }, 300);
                      } else {
                          throw new Error(data.error || 'Delete failed');
                      }
                  })
                  .catch(error => {
                      console.error('Error:', error);
                      // Revert the UI changes
                      keyCard.classList.remove('opacity-0');
                      button.innerHTML = originalContent;
                      button.disabled = false;
                      alert('Failed to delete key: ' + error.message);
                  });
              }
          });
    </script>
  </body>
</html>